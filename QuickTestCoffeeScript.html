<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Quick Test CoffeeScript</title>
  <link rel="stylesheet" href="lib/CodeMirror/lib/codemirror.css">
  <link rel="stylesheet" href="lib/CodeMirror/theme/elegant.css">
  <link rel="stylesheet" href="lib/Touch-Splitter-jQuery/src/touchsplitter.css">
  <style id="style" type="text/css" media="screen">
  html,body,#code-splitter,.CodeMirror{
    width:100%;
    height:100%;
    margin:0;
  }
  /* Styles that I like in ACE and Sublime */
  .CodeMirror {
    font-family: 'source-code-pro', 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    font-size: 16px;
    line-height: 1.3em;
  }
  .CodeMirror:hover {
    cursor: text;
  }
  .CodeMirror .cm-matchhighlight:not(.CodeMirror-selectedtext) {
    outline: 1px solid #bbb;
  }
  .CodeMirror-selected {
    background-color: #333 !important;
  }
  .CodeMirror-selectedtext {
    color: #eee !important;
    text-decoration: none !important;
    font-style: normal !important;
  }
  .CodeMirror-focused div.CodeMirror-cursor {
    /* Whatever your cursor color is: */
    border-right: 1px solid black;
  }
  .cm-error {
    background-color: rgba(255,0,0,0.2) !important
  }
  .TouchSplitter.hTS{overflow:visible;}
  .TouchSplitter .splitter-bar{opacity:0;}
  .CodeMirror{box-shadow:0 0 12px rgba(0,0,0,0.2);}

  .CodeMirror:hover{cursor:text;}
  .CodeMirror-gutters:hover{cursor:default;}
  #output-splitter {
    position:absolute;
    top:42px;
    bottom:0;
    left:0;
    right:0;
  }
  .cm-s-solarized .CodeMirror-gutters{box-shadow: none}
  .splitter-bar{
    background-color: #f5f5f5;
    z-index:4;
    position:relative;
    box-sizing:border-box;
  }

  .error, .title, .action{font-family: "Helvetica Neue", "Lucida Grande", "Lucida Sans Unicode", Helvetica, Arial, sans-serif !important;}
  .header{width:100%;height:42px; position:relative; background-color: #13ACD3;}
  .action, .title {line-height:32px;padding:5px 33px;height:32px;float:left;color:white;margin-right: 2px}
  .title {font-size: 19px; color:white;}
  .action {background:rgba(0,0,0,.2);}
  .action:hover {cursor: pointer}
  .error {position:absolute; right:0;top:0;line-height:42px;padding:0 12px;background: #ff756f}
  .code {font-family: monospace;}

  .dropdown {
    position:relative;
    float:left;
  }
  .dropdown:hover ul {
    z-index: 5;
    display:block;
  }
  .dropdown ul {
    position:absolute;
    display:none;
    list-style:none;
    margin:0;
    padding:0;
    top: 42px;
  }
  .dropdown ul li {background-color: #13ACD3;padding: 10px;width: 200px;}
  .dropdown ul li input {width:150px;padding:1px;margin:1px;}
  .dropdown ul li span:hover {background: #095A6F;}
  .dropdown ul li span {font-weight:bold;cursor:pointer;margin:0;padding:5px;
    color: #FFF;
    display: block;
    background: #067794;
    text-align: center;
  }
  .dropdown.libraries ul li span {
    line-height: 13px;
    float: right;
    width: 13px;    
  }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">Try CoffeeScript</div>
    <div class="action" onclick="editor.run()">Run</div>
    <div class="action" onclick="editor.refresh()">Refresh</div>
    <div class="dropdown libraries">
      <span class="action">Add Library</span>
      <ul>
        <li><input type="text" placeholder="Add js Library URL"></input><span onclick="editor.addLibrary(this)">+</span></li>
      </ul>
    </div>
    <div class="dropdown premade">
      <span class="action">Premade</span>
      <ul>
        <li><span onclick="editor.setPremade(this.innerText)">Fruit Class</span></li>
        <li><span onclick="editor.setPremade(this.innerText)">Extending Fruit Class</span></li>
        <li><span onclick="editor.setPremade(this.innerText)">Array Iteration</span></li>
      </ul>
    </div>
    <div class="action" onclick="editor.share()">Share</div>
    <div class="error" id="error"></div>
  </div>
  <div id="output-splitter">
    <div id="code-splitter">
      <div>
        <textarea id="cm-coffeescript" name="code" rows="5">Say "Hello CoffeeScript"</textarea>
      </div>
      <div>
        <textarea id="cm-javascript" name="code" rows="5"></textarea>
      </div>
    </div>
    <div id="output">
      <div id="compilation"></div>
      <pre id="info"></pre>
    </div>
  </div>
  <footer>
    <script src="lib/CodeMirror/lib/codemirror.js"></script>
    <script src="lib/jquery/dist/jquery.js"></script>
    <script src="lib/CodeMirror/mode/javascript/javascript.js"></script>
    <script src="lib/CodeMirror/mode/coffeescript/coffeescript.js"></script>
    <script src="lib/Touch-Splitter-jQuery/src/jquery.touchsplitter.js"></script>
    <script src="lib/CodeMirror/addon/edit/closebrackets.js"></script>
    <script src="lib/CodeMirror/addon/selection/mark-selection.js"></script>
    <script src="lib/CodeMirror/addon/search/searchcursor.js"></script>
    <script src="lib/CodeMirror/addon/search/match-highlighter.js"></script>
    <script src="lib/CodeMirror/keymap/sublime.js"></script>
    <script src="lib/coffee-script/extras/coffee-script.js"></script>
    <script type="text/coffeescript">
      console.log "CoffeeScript"
      window.editor = {}

      editor.outputSplitter = $("#output-splitter").touchSplit({orientation:"vertical"})
      editor.codeSplitter = $("#code-splitter").touchSplit()

      editor.codeSplitter.on 'resize', (e) ->
        editor.coffeescript.refresh()
        editor.javascript.refresh()
      checkToUseSpacesInsteadofTabs = (cm) ->
        if(cm.getOption("indentWithTabs"))
          return CodeMirror.Pass
        indentUnit = cm.getOption("indentUnit")
        getYoSpaceCount = (head) ->
          # Use preceding to determine what room is taken by tabs
          preceding = cm.getRange {line:head.line, ch:0}, head
          tabCount = 0
          tabreg = /\t/g
          while(tabreg.exec preceding)
            tabCount++
          return indentUnit - (head.ch + tabCount*(indentUnit - 1)) % indentUnit
        makeYoSpaces = (spaceCount) ->
          spaces = ""
          for [1..spaceCount]
            spaces += " "
          return spaces
        putYoSpacesHere = (range) ->
          {anchor, head} = range
          if anchor.line isnt head.line and anchor.ch isnt head.ch
            for line in [anchor.line...head.line]
              curLine = cm.getLine(line)
              curPos = {line, ch:0}
              cm.replaceRange makeYoSpaces(indentUnit), curPos, curPos
            #anchor.ch += indentUnit
            #head.ch += indentUnit
          else
            cm.replaceRange makeYoSpaces(getYoSpaceCount(head)), anchor, head
        cm.doc.sel.ranges.forEach putYoSpacesHere
      editor.coffeescript = CodeMirror.fromTextArea document.getElementById("cm-coffeescript"), {
        mode: "coffeescript"
        tabMode: "indent"
        useTabs: true
        indentWithTabs: false
        indentUnit: 2
        theme: "elegant"
        styleSelectedText: true
        lineNumbers: true
        autoCloseBrackets: true
        showCursorWhenSelecting: true
        autofocus: true
        keyMap: "sublime"
        extraKeys:
          "Tab" : checkToUseSpacesInsteadofTabs
          "Ctrl-Enter": ->
            editor.run()
          "Ctrl-S": ->
            Clear()
            editor.run()
      }
      editor.javascript = CodeMirror.fromTextArea document.getElementById("cm-javascript"), {
        mode: "javascript"
        styleSelectedText: true
        showCursorWhenSelecting: true
        cursorBlinkRate: 0
        keyMap: "sublime"
        readOnly: true
      }
      editor.compile = ->
        source = editor.coffeescript.doc.getValue()
        editor.compiledJS = ""
        try
          editor.compiledJS = CoffeeScript.compile source, bare: on
          editor.javascript.doc.setValue(editor.compiledJS)
          $('#error').hide()
          editor.errorHandler null
        catch {location, message}
          if location?
            message = "Error on line #{location.first_line + 1}: #{message}"
          $('#error').text(message).show()
          editor.errorHandler {location, message}
      editor.currentError = null
      editor.errorHandler = (err) ->
        editor.currentError?.clear?()
        editor.currentError = null
        if err
          err = err.location
          if (not err.last_column and not err.last_line) or
             (err.last_column is err.first_column and err.last_line is err.first_line)
            editor.currentError = editor.coffeescript.setBookmark(
              {line:err.first_line, ch:err.first_column},
              {widget:editor.makeWidget()}
            )
          else  
            editor.currentError = editor.coffeescript.markText(
              {line:err.first_line, ch:err.first_column},
              {line:err.last_line,  ch:err.last_column},
              {className:"cm-error"}
            )
      editor.makeWidget= ->
        widget = document.createElement("span")
        widget.style.borderLeft = "1px solid rgba(255,50,50,.6)"
        widget.style.borderRight = "1px solid rgba(255,120,120,.6)"
        widget.style.marginLeft = "-1px"
        widget.style.marginRight = "-1px"
        widget
      editor.run = ->
        script = document.createElement("script");
        script.innerHTML = editor.compiledJS
        $("#compilation").html("").append(script)
      editor.store = ->
        if Storage?
          sessionStorage.code = editor.coffeescript.getValue()
        else
          return false
      editor.storeLibraries = ->
        if Storage?
          localStorage.libraries = editor.getDistinctArray(editor.libraries).join ','
        else
          return false
      editor.refresh = ->
        location.href = location.href.replace /#.+$/, ''
      editor.coffeescript.on "change", ->
        editor.compile()
        editor.store()
      editor.libraries = []
      editor.scriptsLoading = 0
      editor.que = ()->
        editor.scriptsLoading++
        return (success, url)->
          editor.scriptsLoading--
          if success
            Say "<span style='color:green'><a href='#{url}'>#{url}</a> loaded.</span>"
          else
            Say "<span style='color:red'><a href='#{url}'>#{url}</a> failed to load.</span>"
          if editor.scriptsLoading is 0
            Say "All scripts are loaded"

      editor.addLibrary = (siblingelement)->
        urlInput = $(siblingelement.parentNode).find("input")
        url = urlInput.val()
        urlInput.val("")
        editor.addLibraryFromUrl url


      editor.addLibraryFromUrl = (url)->
        editor.loadLibrary(url)
        editor.libraries.push url
        editor.libraries = editor.getDistinctArray editor.libraries
        localStorage.libraries = editor.libraries.join(',')
        libraryli = document.createElement 'li'
        hex = Math.random() * 0xFFFFFF
        libraryli.innerHTML = """
          <a id='lib#{hex.toString()}' href='#{url}'>
            #{(url.match /([^\/]+\.js$)/)[1]}
          </a>
          <span>-</span>
        """
        $('.dropdown.libraries ul').append(libraryli).find('span').click editor.remLibrary

      editor.remLibrary = (event)->
        liUrl = $(event.target).parent()
        url = liUrl.find('a').attr('href')
        liUrl.remove()
        newLibs = []
        for lib in editor.libraries
          if lib isnt url
            newLibs.push lib
        editor.libraries = newLibs
        editor.storeLibraries()
        editor.refresh()

      editor.loadLibrary = (libURL) ->
        que = editor.que()
        $.getScript(libURL).done(()->
          que(true,libURL)
        ).fail () ->
          console.log arguments
          que(false,libURL)

      editor.share = ->
        window.prompt "Link to share: (Ctrl-C, Enter)", location.href.replace(/#.+$/, '') + '#' + encodeURIComponent editor.coffeescript.getValue()
      editor.getDistinctArray = (arr) ->
        dups = {}
        arr.filter (el)->
          hash = el.valueOf()
          isDup = dups[hash]
          dups[hash] = true
          return !isDup

      editor.setPremade = (premadeName) ->
        @coffeescript.setValue(premade[premadeName])
      premade = {
        "Fruit Class":"""
class Fruit
  constructor: (@name) ->

  eat: ->
    Say \"I\'m eating \#{@name}\"

apple = new Fruit(\"Apple\")

apple.eat()
"""
        "Extending Fruit Class": """
class Fruit
  constructor: (@name) ->

  eat: ->
    Say \"I\'m eating \#{@name}\"

class ColoredFruit extends Fruit
  constructor: (name, @color) ->
    super(name)

  observe: ->
    Say \"I\'m a \#{@color} \#{@name}\"

  eatIfColor: (colorYouLike) ->
    if @color is colorYouLike
      @eat()
    else
      Say (\"I don\'t like \#{@name}, because they are \#{@color}\")

apple = new ColoredFruit(\"Apple\", \"red\")

apple.observe()

apple.eatIfColor(\"red\")
"""
        "Array Iteration": """
nums = [0..5] # [0,1,2,3,4,5]

for num in nums when num%2 is 0
  Say \"Even: \" + num

for num in nums[1..3]
  Say \"Sliced: \" + num
"""

      }
      if Storage? and sessionStorage.code
        editor.coffeescript.setValue sessionStorage.code

      if Storage? and localStorage.libraries
        editor.libraries = editor.getDistinctArray localStorage.libraries.split ','
        for libURL in editor.libraries
          editor.addLibraryFromUrl(libURL)

      if location.hash
        editor.coffeescript.setValue decodeURIComponent location.hash[1..]
        editor.refresh() if editor.store()
      editor.compile()
    </script>
    <script>
      Say = function(o){
        console.log(o)
        $("#info").append(o.toString() + "\n")
      }
      Clear = function(){
        $("#info").html('')
      }
    </script>
  </footer>
</body>
</html>
